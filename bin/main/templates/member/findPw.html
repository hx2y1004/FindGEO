<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<head>
	<meta charset="UTF-8">
    <!--<script type="text/javascript" src="/scripts/jquery-ui/jquery.min.js"></script>
	<script type="text/javascript" src="/scripts/common/common-ui.js"></script>-->
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
<title>ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸°</title>
<meta id="_csrf" name="_csrf" th:content="${_csrf.token}"/>
<meta id="_csrf_header" name="_csrf_header" th:content="${_csrf.headerName}"/>
</head>
<style>
	@font-face {
	 font-family: 'GmarketSansMedium';
	 src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_2001@1.1/GmarketSansMedium.woff') format('woff');
	 font-weight: normal;
	 font-style: normal;
	}
	*{font-family: 'GmarketSansMedium';}
	#findpw{
	text-align: center;
	margin-top: 15%;
	}
	table{
	margin: auto;
	margin-bottom: 15%;
	width:700px;
	height: 100px;
	}
	#num{
	font-size: 20px;
	}
	#email,#to,#checknum{
	border:2px solid #04479b;
	border-radius: 5px;
	background-color: #d3d3d38a;
	height: 35px;
	margin-bottom: 5px;
	}
	.to,.checknum{
	border:2px solid #04479b;
	border-radius: 5px;
	}
	#checknum{
	margin-left: -85px;
	}
	


</style>
<body>
<div id="findpw">
    <h1>ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸°ğŸ”</h1>
 	<input type="hidden" id="chkNum" th:value=${checkNum}/>
 	<input type="hidden" id="member" th:value=${member} />
<table>
        <tr class="form-group">
        	<td id="num">ì´ë©”ì¼</td>
            <td>
                <input type="text" class="form-control" id="email" name="email" placeholder="ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”">
            </td>
        </tr>
        <tr>
            <td id="num">ì „í™”ë²ˆí˜¸</td>
            <td>
                <input type="text" class="form-control" id="to" name="to" placeholder="ì „í™”ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
            </td>
            <td>
        		<button id="sendSms" name="sendSms">ì¸ì¦ë²ˆí˜¸ ì „ì†¡</button>
        	</td>
        </tr>
        <tr>
        	<td id="num">ì¸ì¦ë²ˆí˜¸</td>
			<td>
				<input type="text" id="checknuminput" name = "checknuminput"><span id="timer"></span>
			</td>
			<td>
				<button id="checknum" name="checknum"  disabled="disabled">ì¸ì¦ë²ˆí˜¸ í™•ì¸</button>            
			</td>
        </tr>
    </table>
 
</div>
<script>
$('#sendSms').click(function(){
	const email = document.getElementById('email').value;
	const phone = document.getElementById('to').value;
	const to = document.getElementById('to').value; 
	const content = "";
	const target = document.getElementById("checknum");
	const data = {
		to : to,
		content : content,
		email : email
	}
	var token = $("meta[name='_csrf']").attr("content");
	var header = $("meta[name='_csrf_header']").attr("content");
	
		$.ajax({
			beforeSend: function(xhr){
			    xhr.setRequestHeader(header,token);
			},
			type: "post",
			url: "/members/chkmember",
			dateType: "json",
			data: JSON.stringify(data),
	        contentType : 'application/json; charset=utf-8'
	        }).done(function(e){
				if(e == "true"){
					$.ajax({
						beforeSend: function(xhr){
						    xhr.setRequestHeader(header,token);
						},
						type: "post",
						url: "/members/sendsmsPw",
						dateType: "json",
						data: JSON.stringify(data),
				        contentType : 'application/json; charset=utf-8',
						success: function(data) {
					    	alert("ë¬¸ìê°€ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
				    		target.disabled = false;
					    	// íƒ€ì´ë¨¸ êµ¬í˜„_daldal
							function $ComTimer(){
							    //prototype extend
							}
							
							$ComTimer.prototype = {
							    comSecond : ""
							    , fnCallback : function(){}
							    , timer : ""
							    , domId : ""
							    , fnTimer : function(){
							        var m = Math.floor(this.comSecond / 60) + "ë¶„ " + (this.comSecond % 60) + "ì´ˆ";	// ë‚¨ì€ ì‹œê°„ ê³„ì‚°
							        this.comSecond--;					// 1ì´ˆì”© ê°ì†Œ
							        console.log(m);
							        this.domId.innerText = m;
							        if (this.comSecond < 0) {			// ì‹œê°„ì´ ì¢…ë£Œ ë˜ì—ˆìœ¼ë©´..
							            clearInterval(this.timer);		// íƒ€ì´ë¨¸ í•´ì œ
							            alert("ì¸ì¦ì‹œê°„ì´ ì´ˆê³¼í•˜ì˜€ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì¸ì¦í•´ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.");
							            window.close();
							            window.opener.location = "/index.do"
							        }
							    }
							    ,fnStop : function(){
							        clearInterval(this.timer);
							    }
							}
							
							var AuthTimer = new $ComTimer()
							AuthTimer.comSecond = 180; // ì œí•œ ì‹œê°„
							AuthTimer.fnCallback = function(){alert("ë‹¤ì‹œì¸ì¦ì„ ì‹œë„í•´ì£¼ì„¸ìš”.")}; // ì œí•œ ì‹œê°„ ë§Œë£Œ ë©”ì„¸ì§€
							AuthTimer.timer =  setInterval(function(){AuthTimer.fnTimer()},1000); 
							AuthTimer.domId = document.getElementById("timer");
						},
						error: function(data){
							alert("ë¬¸ì ë°œì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
						}
					});
				}else{
					console.log("ì¸ì¦ ì‹¤íŒ¨");
					alert("ë“±ë¡ëœ ì´ë©”ì¼ê³¼ ì „í™”ë²ˆí˜¸ê°€ ì—†ìŠµë‹ˆë‹¤.")
				}
			})
});

$('#checknum').click(function() {
	const inputCode = document.getElementById('checknuminput').value;	
	//const checkNum = document.getElementById('chkNum').value;
	console.log("checkclick ++ " + inputCode);
	const to = document.getElementById('to').value; 
	const data = {
		inputCode : inputCode,
		to : to
	}
	var token = $("meta[name='_csrf']").attr("content");
	var header = $("meta[name='_csrf_header']").attr("content");
	$.ajax({
		beforeSend: function(xhr){
		    xhr.setRequestHeader(header,token);
		},
		type: "post",
		url: "/members/chksendid",
		dateType: "json",
		data: JSON.stringify(data),
        contentType : 'application/json; charset=utf-8'
        }).done(function(e){
			if(e === inputCode){
				alert("ë²ˆí˜¸ ì¸ì¦ ì„±ê³µ");
				window.location.href = '/members/changePw/'+to;
			}else{
				console.log("ì¸ì¦ ì‹¤íŒ¨");
				alert("ì¸ì¦ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.")
			}
		})
});

</script>
</body>
</html>