<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{layouts/layout2}">
<meta charset="UTF-8">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>

<head>
	<title>ì•„ì´ë”” ì°¾ê¸°</title>
	<meta id="_csrf" name="_csrf" th:content="${_csrf.token}" />
	<meta id="_csrf_header" name="_csrf_header" th:content="${_csrf.headerName}" />
</head>
<th:block layout:fragment="css">
	<style>
		#findid {
			text-align: center;
			margin-top: 15%;
		}

		table {
			margin: auto;
			margin-bottom: 15%;
			width: 700px;
			height: 100px;
		}

		#sendSms {
			width: 120px;
		}

		#checknuminput {
			border: 2px solid #04479b;
			border-radius: 5px;
			background-color: #d3d3d38a;
			height: 35px;
			width: 300px;
			margin-left: -65px;
		}

		#to {
			border: 2px solid #04479b;
			border-radius: 5px;
			background-color: #d3d3d38a;
			height: 35px;
		}

		#num {
			font-size: 20px;
		}

		button {
			border: 2px solid #04479b;
			width: 120px;
			border-radius: 5px;
			background-color: #F0F0F0;
		}

		#num td {
			margin-top: -5px;
		}
	</style>
</th:block>

<body>
	<div layout:fragment="content2">
		<div id="findid">
			<h1>ì•„ì´ë”” ì°¾ê¸°ğŸ”</h1>
			<input type="hidden" id="chkNum" th:value=${checkNum} />
			<table>
				<tr class="form-group">
					<td id="num" colspan="2">ì „í™”ë²ˆí˜¸</td>
					<td>
						<input type="text" class="form-control" id="to" name="to" placeholder="ì „í™”ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.">
					</td>
					<td>
						<button id="sendSms" name="sendSms">ì¸ì¦ë²ˆí˜¸ ì „ì†¡</button>
					</td>
				</tr>
				<tr>
					<td colspan="2" id="num">ì¸ì¦ë²ˆí˜¸</td>
					<td>
						<input type="text" id="checknuminput" name="checknuminput"><span id="timer"></span>
					</td>
					<td>
						<button class="checknum" id="checknum" name="checknum" disabled="disabled">ì¸ì¦ë²ˆí˜¸ í™•ì¸</button>

					</td>
				</tr>
			</table>
		</div>
		<img src="/images/b1.png" width="50px" height="50px" onclick="window.history.back();"
			style="position: fixed; bottom:20px; right:20px;" id="back">
		<script>
			$('#sendSms').click(function () {
				const to = document.getElementById('to').value;
				const content = "";
				const target = document.getElementById("checknum");
				const data = {
					to: to,
					content: content
				}
				var token = $("meta[name='_csrf']").attr("content");
				var header = $("meta[name='_csrf_header']").attr("content");
				console.log(to);
				$.ajax({
					beforeSend: function (xhr) {
						xhr.setRequestHeader(header, token);
					},
					type: "post",
					url: "/members/sendsmsId",
					dateType: "json",
					data: JSON.stringify(data),
					contentType: 'application/json; charset=utf-8',
					success: function (data) {
						alert("ë¬¸ìê°€ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
						target.disabled = false;
						// íƒ€ì´ë¨¸ êµ¬í˜„_daldal
						function $ComTimer() {
							//prototype extend
						}

						$ComTimer.prototype = {
							comSecond: ""
							, fnCallback: function () { }
							, timer: ""
							, domId: ""
							, fnTimer: function () {
								var m = Math.floor(this.comSecond / 60) + "ë¶„ " + (this.comSecond % 60) + "ì´ˆ";	// ë‚¨ì€ ì‹œê°„ ê³„ì‚°
								this.comSecond--;					// 1ì´ˆì”© ê°ì†Œ
								console.log(m);
								this.domId.innerText = m;
								if (this.comSecond < 0) {			// ì‹œê°„ì´ ì¢…ë£Œ ë˜ì—ˆìœ¼ë©´..
									clearInterval(this.timer);		// íƒ€ì´ë¨¸ í•´ì œ
									alert("ì¸ì¦ì‹œê°„ì´ ì´ˆê³¼í•˜ì˜€ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì¸ì¦í•´ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.");
									window.close();
									window.opener.location = "/index.do"
								}
							}
							, fnStop: function () {
								clearInterval(this.timer);
							}
						}

						var AuthTimer = new $ComTimer()

						AuthTimer.comSecond = 180; // ì œí•œ ì‹œê°„

						AuthTimer.fnCallback = function () {alert("ë‹¤ì‹œì¸ì¦ì„ ì‹œë„í•´ì£¼ì„¸ìš”.")}; // ì œí•œ ì‹œê°„ ë§Œë£Œ ë©”ì„¸ì§€

						AuthTimer.timer = setInterval(function () {AuthTimer.fnTimer()}, 1000);

						AuthTimer.domId = document.getElementById("timer");
					},
					error: function (data) {
						alert("ë¬¸ì ë°œì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
					}
				});
			});
			$('#checknum').click(function () {
				const inputCode = document.getElementById('checknuminput').value;
				//const checkNum = document.getElementById('chkNum').value;
				console.log("checkclick ++ " + inputCode);
				const to = document.getElementById('to').value;
				const data = {
					inputCode: inputCode,
					to: to
				}
				var token = $("meta[name='_csrf']").attr("content");
				var header = $("meta[name='_csrf_header']").attr("content");
				$.ajax({
					beforeSend: function (xhr) {
						xhr.setRequestHeader(header, token);
					},
					type: "post",
					url: "/members/chksendid",
					dateType: "json",
					data: JSON.stringify(data),
					contentType: 'application/json; charset=utf-8'
				}).done(function (e) {
					if (e === inputCode) {
						alert("ë²ˆí˜¸ ì¸ì¦ ì„±ê³µ");
						window.location.href = '/members/viewId/' + to;
					} else {
						console.log("ì¸ì¦ ì‹¤íŒ¨");
						alert("ì¸ì¦ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.")
					}
				})
			});
		</script>
	</div>
</body>

</html>